# Smart Shit

Walking to the toilets just to find them currently occupied is a pretty bad thing to ruin your day. So we decided to bring the toilet status into our intranet using AWS IoT.

## The Hardware

### Cloud Box

The model for the 3D printed box containing the boards is derived from Thingiverse #606055 by mrtial (http://bit.ly/2o5Qejy), repaired to a valid 2-manifold for printing using MakePrintable (http://bit.ly/2o3OLLq) and FreeCad (http://bit.ly/2nTuqFH) and resized to 70%.

### Controller Board

The boards are Adafruit WICED WiFi Feather boards (http://bit.ly/2n7PBXA) that are powerful enough to handle the MQTT/HTTP via TLS 1.2 Certs requests required by AWS IoT.

### Also, we used a switch and some cables...

## The Software

### On the Feather Boards

The Feather Boards have a very simple software setup using the AWS IoT SDK, connecting to the AWS Cloud on Powerup and then watching for the swich to be triggered, updating the status in AWS IoT. The Boards do a reconnect if dropped from Wifi and do a regular status send as a timeout too to catch any lost messages that might have happened due to a connection loss or power outage.

#### Setup
 - Setup your Arduino IDE for usage of the Adafruit WICED Feather Boards by adding them in the Boards Manager
 - Make sure you got the Adafruit MQTT Library installed
 - Create wlan.h file as specified below
 - Create an account or log in at http://aws.amazon.com/iot
 - Create a THING and name it
 - Select the created thing and choose "Connect a Device", then select "Embeeded C" and click "Genereate Certificate and Policy"
 - Download the generated certificate and private key to the Board folder. Then click "Confirm & Start connecting"
 - Then You could see these AWS_IOT_MQTT_HOST, AWS_IOT_MQTT_PORT, AWS_IOT_MQTT_CLIENT_ID, AWS_IOT_MY_THING_NAME, copy these and put them into a config.h file like defined below. (You could always view this later in your resource management). 
 - Copy the contents of private key to 'aws_private_key' variable in the privatekey.h file  
   NOTE: Each line must be added with '\n' and quoted with " " to be parsed successfully.
 - Using pycert to convert certificate to header file by running  
   `$ python ../../../tools/pycert/pycert.py convert -c local_cert -l LOCAL_CERT_LEN 214900e9fd-certificate.pem.crt.txt`  
   This should create an certificates.h with variable local_cert.
 - Open the Board.ino
 - Compile and run

#### config.h
```c
#define AWS_IOT_MQTT_HOST              "AWS_IOT_MQTT_HOST"
#define AWS_IOT_MQTT_PORT              AWS_IOT_MQTT_PORT
#define AWS_IOT_MQTT_CLIENT_ID         "AWS_IOT_MQTT_CLIENT_ID"
#define AWS_IOT_MY_THING_NAME          "AWS_IOT_MY_THING_NAME"
```

#### certificates.h

This will be generated by pycert

#### privatekey.h

You should put your private key in here for the specific device, the file should look like this:

```c
const char aws_private_key[] = 
"-----BEGIN RSA PRIVATE KEY-----\n"
"MIIEp......whatever\n"
...
"LF5X.......dxA=="
"-----END RSA PRIVATE KEY-----";
```

#### wlan.h

This does contain the WiFi Authentication and should look like this:

```c
#define WLAN_SSID         "IoTWifi"
#define WLAN_PASS         "IoTPassword"
```

## Webreader

We use the AWS IoT Node.js SDK to display the current toilet state in our intranet.
Webreader is a standalone app based on Node.js, Express, socket.io, jQuery, CSS, HTML, and will be embedded in an iframe in our intranet.

### Setup Webreader

#### Install all dependencies
```sh
npm install
```
#### Edit and rename private.config.json
You have to rename the private.config file to config.json
And complete your ceredentials 

```json
{
    "port": 8080,
    "thingName": "yourThingName",
    "things": [{
        "thingName": "yourThingName"
    }],
    "certName": "yourCert",
    "prefix": "yorPrefix",
    "certPath": "yourCerts/",
    "region": "yourRegion //us-west-2",
    "host": "yourHost //xxxxxxxxxxxxx.iot.yourRegion.amazonaws.com"
}
```

#### start webserver
```sh
node server.js
```
Now the Webreader is serverd under localhost:PORT default (localhost:8080)
